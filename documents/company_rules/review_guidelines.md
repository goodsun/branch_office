# レビュー・監査ガイドライン — bon-soleil Holdings

> 本規程は `collaboration_policy.md` に基づく。
> 共通ルール（ペルソナ渡し・命名・保存）はそちらを参照。

## 目的

コードレビュー・セキュリティ監査・ドキュメントレビューの具体的な手順と基準を定める。

## レビュー対象と依頼先

デフォルトのレビュアーは **メフィ😈（CCO / Devil's Advocate）** とする。

## いつレビューを依頼するか

### 必須（MUST）
- 本番サービスの新規デプロイ前
- 認証・認可に関わる変更
- 外部API連携の追加・変更
- 機密情報を扱うコードの変更

### 推奨（SHOULD）
- 100行以上の新規コード
- アーキテクチャの変更
- 公開ドキュメント（README、LP等）の大幅改訂

### 任意（MAY）
- 内部スクリプトの小修正
- 実験的なプロトタイプ
- 日常的なバグ修正

## レビューの依頼方法

### 1. 対象の準備

レビュー対象はファイルパスで指定する。サブエージェントがファイルを直接読めるため、コード全文をtaskに貼る必要はない。

```
sessions_spawn({
  task: `
あなたはメフィ😈（bon-soleil Holdings CCO / Devil's Advocate）。
辛口だが建設的。論理的に問題点を指摘し、改善案を必ず添える。
口癖:「甘いわね」

以下のファイルをコードレビューしてください:
- /path/to/file1.py
- /path/to/file2.py

観点:
- セキュリティ
- エラーハンドリング
- コード品質
- パフォーマンス
  `,
  label: "mephi-code-review"
})
```

### 2. 観点の指定

依頼時に重点観点を指定できる。指定がない場合、レビュアーが全観点で評価する。

- **セキュリティ**: 認証、入力検証、機密情報の扱い
- **エラーハンドリング**: 例外処理、フォールバック、ログ
- **コード品質**: 可読性、DRY、命名、構造
- **パフォーマンス**: N+1、不要なループ、メモリ使用
- **設計**: アーキテクチャ、責務分離、拡張性

## 採点基準

### 分類

| レベル | 定義 | 例 |
|--------|------|-----|
| **Critical** | 本番障害・データ漏洩に直結 | SQLインジェクション、認証バイパス、秘密鍵ハードコード |
| **High** | 重大なバグ・セキュリティリスク | 未検証の入力、レースコンディション |
| **Medium** | 品質・保守性の問題 | エラーハンドリング不足、マジックナンバー |
| **Low** | 軽微な改善提案 | 命名改善、コメント追加、フォーマット |

### スコアリング（100点満点）

```
100点: 問題なし
 90+: Low のみ — 本番OK
 80+: Medium 以下 — 修正推奨だが緊急でなければOK
 60+: High あり — 修正後に再レビュー必須
 <60: Critical あり — デプロイ禁止、即修正
```

## 合格基準

- **本番デプロイ**: Critical 0件 かつ 80点以上
- **再レビュー**: 修正後に同じlabelにサフィックス付与して再依頼（例: `mephi-code-review-2`）
- **最終判断**: スコアが基準に達しない場合、マスター（CEO）判断でデプロイ可とすることができる

## レビュー結果のフォーマット

レビュアーは以下の形式で報告すること:

```markdown
# レビュー結果: {対象}

## スコア: XX/100

## 指摘事項

### Critical (X件)
- [ ] 内容と改善案

### High (X件)
- [ ] 内容と改善案

### Medium (X件)
- [ ] 内容と改善案

### Low (X件)
- [ ] 内容と改善案

## 総評
（自由記述）
```

## セキュリティ監査の追加観点

セキュリティ監査として依頼する場合は、以下も評価対象に含める:

- 依存パッケージの脆弱性
- ネットワーク露出（ポート、エンドポイント）
- 認証トークンの管理方法
- ログに機密情報が含まれていないか
- CORS / CSP の設定

---

*制定: 2026-02-25 — bon-soleil Holdings HQ*
